// 等待appwrite-init.js加载完成（关键！）
window.addEventListener('load', async () => {
    // 确认appwrite是否已加载
    if (!window.appwrite) {
        alert('Appwrite初始化失败，请刷新页面重试');
        return;
    }

    // 初始化星空背景
    createStars();

    // 切换登录/注册标签页
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-panel`).classList.add('active');
            document.getElementById('login-message').textContent = '';
            document.getElementById('reg-message').textContent = '';
        });
    });

    // 注册功能
    document.getElementById('register-btn').addEventListener('click', async () => {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const confirmPwd = document.getElementById('reg-confirm').value;
        const messageEl = document.getElementById('reg-message');

        if (!username || !password) {
            messageEl.textContent = '用户名和密码不能为空';
            messageEl.className = 'message error';
            return;
        }
        if (password.length < 6) {
            messageEl.textContent = '密码长度不能少于6位';
            messageEl.className = 'message error';
            return;
        }
        if (password !== confirmPwd) {
            messageEl.textContent = '两次输入的密码不一致';
            messageEl.className = 'message error';
            return;
        }

        try {
            // 调用Appwrite创建账号（这里会用到window.appwrite.account）
            const user = await window.appwrite.account.create(
                crypto.randomUUID(),
                `${username}@cait.com`,
                password,
                username
            );

            const hexUserId = await window.appwrite.generateHexId();

            await window.appwrite.databases.createDocument(
                window.appwrite.dbId,
                window.appwrite.collId,
                user.$id,
                { username, userId: hexUserId, createdAt: new Date().toLocaleString() }
            );

            messageEl.textContent = `注册成功！你的专属ID：${hexUserId}`;
            messageEl.className = 'message success';
            setTimeout(() => document.querySelector('.tab[data-tab="login"]').click(), 2000);
        } catch (error) {
            messageEl.textContent = '注册失败：' + (error.message || '系统错误');
            messageEl.className = 'message error';
        }
    });

    // 登录功能
    document.getElementById('login-btn').addEventListener('click', async () => {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        const messageEl = document.getElementById('login-message');

        if (!username || !password) {
            messageEl.textContent = '用户名和密码不能为空';
            messageEl.className = 'message error';
            return;
        }

        try {
            await window.appwrite.account.createEmailSession(
                `${username}@cait.com`,
                password
            );
            messageEl.textContent = '登录成功，正在跳转...';
            messageEl.className = 'message success';
            setTimeout(() => {
                window.location.href = 'https://pu-94.github.io/CAIT-STUDIO/index.html';
            }, 1000);
        } catch (error) {
            messageEl.textContent = '用户名或密码错误';
            messageEl.className = 'message error';
        }
    });

    // 检查登录状态
    try {
        await window.appwrite.account.get();
        window.location.href = 'https://pu-94.github.io/CAIT-STUDIO/index.html';
    } catch (error) {}
});
